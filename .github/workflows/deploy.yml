name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main, master ]

concurrency:
  group: azure-deploy-${{ vars.AZURE_RESOURCE_GROUP }}-${{ github.workflow }}-blog-lawsonsites-com-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install
        run: npm install
      - name: Build with branding environment variables
        run: npm run build
        env:
          NEXT_PUBLIC_ORG_NAME: ${{ secrets.NEXT_PUBLIC_ORG_NAME }}
          NEXT_PUBLIC_ORG_LOGO_URL: ${{ secrets.NEXT_PUBLIC_ORG_LOGO_URL }}
          BLOG_TENANT_ID: ${{ secrets.BLOG_TENANT_ID }}
          NEXT_PUBLIC_BLOG_TENANT_ID: ${{ secrets.NEXT_PUBLIC_BLOG_TENANT_ID }}
          NEXT_PUBLIC_PRIMARY_COLOR: ${{ secrets.NEXT_PUBLIC_PRIMARY_COLOR }}
          NEXT_PUBLIC_SECONDARY_COLOR: ${{ secrets.NEXT_PUBLIC_SECONDARY_COLOR }}
          NEXT_PUBLIC_TERTIARY_COLOR: ${{ secrets.NEXT_PUBLIC_TERTIARY_COLOR }}
          NEXT_PUBLIC_BACKGROUND_COLOR: ${{ secrets.NEXT_PUBLIC_BACKGROUND_COLOR }}
          NEXT_PUBLIC_FOREGROUND_COLOR: ${{ secrets.NEXT_PUBLIC_FOREGROUND_COLOR }}
          NEXT_PUBLIC_SURFACE_COLOR: ${{ secrets.NEXT_PUBLIC_SURFACE_COLOR }}
          NEXT_PUBLIC_SURFACE_MUTED_COLOR: ${{ secrets.NEXT_PUBLIC_SURFACE_MUTED_COLOR }}
          NEXT_PUBLIC_MUTED_COLOR: ${{ secrets.NEXT_PUBLIC_MUTED_COLOR }}
          NEXT_PUBLIC_MUTED_FOREGROUND_COLOR: ${{ secrets.NEXT_PUBLIC_MUTED_FOREGROUND_COLOR }}
          NEXT_PUBLIC_SEO_TITLE: ${{ secrets.NEXT_PUBLIC_SEO_TITLE }}
          NEXT_PUBLIC_SEO_DESCRIPTION: ${{ secrets.NEXT_PUBLIC_SEO_DESCRIPTION }}
          NEXT_PUBLIC_SEO_KEYWORDS: ${{ secrets.NEXT_PUBLIC_SEO_KEYWORDS }}
          COSMOS_MYSQL_HOST: ${{ secrets.COSMOS_MYSQL_HOST }}
          COSMOS_MYSQL_PORT: ${{ secrets.COSMOS_MYSQL_PORT }}
          COSMOS_MYSQL_USERNAME: ${{ secrets.COSMOS_MYSQL_USERNAME }}
          COSMOS_MYSQL_PASSWORD: ${{ secrets.COSMOS_MYSQL_PASSWORD }}
          COSMOS_MYSQL_DATABASE: ${{ secrets.COSMOS_MYSQL_DATABASE }}
          COSMOS_MYSQL_SSL: ${{ secrets.COSMOS_MYSQL_SSL }}
          COSMOS_MYSQL_CA_CERT: ${{ secrets.COSMOS_MYSQL_CA_CERT }}
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Build and Push Image to ACR
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az acr build --registry ${{ vars.AZURE_CONTAINER_REGISTRY_NAME }} --image blog-1763438021648-39ljli9xj:${{ github.sha }} --file Dockerfile .
      - name: Deploy to Azure Container Apps
        uses: azure/CLI@v2
        with:
          inlineScript: |
            set -euo pipefail
            APP_NAME="blog-lawsonsites-com"
            RG=${{ vars.AZURE_RESOURCE_GROUP }}
            ACR_NAME=${{ vars.AZURE_CONTAINER_REGISTRY_NAME }}
            echo "Resolving ACR login server for $ACR_NAME..."
            LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)
            IMAGE="$LOGIN_SERVER/blog-1763438021648-39ljli9xj:${{ github.sha }}"
            echo "Target image: $IMAGE"

            echo "Waiting for any active provisioning to complete for $APP_NAME..."
            attempts=60
            sleep_secs=10
            for i in $(seq 1 $attempts); do
              state=$(az containerapp show -n "$APP_NAME" -g "$RG" --query "properties.provisioningState" -o tsv || echo "")
              if [ -z "$state" ] || [ "$state" = "Succeeded" ]; then
                break
              fi
              echo "App state: $state. Waiting ($i/$attempts)..."
              sleep "$sleep_secs"
            done

            echo "Updating container app with retries..."
            retries=10
            backoff=5
            for i in $(seq 1 $retries); do
              ENV_VARS=""
              if [ -n "${{ secrets.COSMOS_MYSQL_HOST }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_HOST=${{ secrets.COSMOS_MYSQL_HOST }}"; fi
              if [ -n "${{ secrets.COSMOS_MYSQL_PORT }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_PORT=${{ secrets.COSMOS_MYSQL_PORT }}"; fi
              if [ -n "${{ secrets.COSMOS_MYSQL_USERNAME }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_USERNAME=${{ secrets.COSMOS_MYSQL_USERNAME }}"; fi
              if [ -n "${{ secrets.COSMOS_MYSQL_PASSWORD }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_PASSWORD=${{ secrets.COSMOS_MYSQL_PASSWORD }}"; fi
              if [ -n "${{ secrets.COSMOS_MYSQL_DATABASE }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_DATABASE=${{ secrets.COSMOS_MYSQL_DATABASE }}"; fi
              if [ -n "${{ secrets.COSMOS_MYSQL_SSL }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_SSL=${{ secrets.COSMOS_MYSQL_SSL }}"; fi
              if [ -n "${{ secrets.COSMOS_MYSQL_CA_CERT }}" ]; then ENV_VARS="$ENV_VARS COSMOS_MYSQL_CA_CERT=${{ secrets.COSMOS_MYSQL_CA_CERT }}"; fi
              if [ -n "$ENV_VARS" ]; then
                if az containerapp update --name "$APP_NAME" --resource-group "$RG" --image "$IMAGE" --set-env-vars $ENV_VARS --output none; then
                  echo "Update succeeded."
                  exit 0
                fi
              else
                if az containerapp update --name "$APP_NAME" --resource-group "$RG" --image "$IMAGE" --output none; then
                  echo "Update succeeded."
                  exit 0
                fi
              fi
              err_state=$(az containerapp show -n "$APP_NAME" -g "$RG" --query "properties.provisioningState" -o tsv || echo "")
              echo "Update failed (attempt $i/$retries). provisioningState=$err_state. Retrying in $backoff s..."
              sleep "$backoff"
              if [ $backoff -lt 60 ]; then backoff=$((backoff*2)); else backoff=60; fi
            done

            echo "Deployment failed after retries."
            exit 1
